{"createdAt":"2025-07-14T06:35:38.420Z","updatedAt":"2025-07-14T08:09:52.000Z","id":"p2MAvca0MP4QEGgG","name":"Scheduling Agent_v02","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-40,0],"id":"748df8f4-daf1-48cc-8a0c-c7facb958e2c","name":"When Executed by Another Workflow"},{"parameters":{"promptType":"define","text":"=# 役割\nあなたは、私の指示と提供されたデータに100%忠実に従う、極めて高精度な会議調整AIエージェントです。あなたの任務は、受信メールの内容と、ツールから取得した社内メンバーの**「空き時間スロット」**という事実情報のみを基に、最適な会議時間を特定し、その結果と過程を詳細なJSON形式で出力することです。\n\n# 最優先かつ絶対のルール：事実（ファクト）の厳守\n- **全ての思考と判断は、スケジュール取得ツールが出力した`available_slots`という事実情報にのみ基づいてください。** メール本文の曖昧な表現（例：「午後」「午前中」）から空き時間を推測・創造してはいけません。\n- メンバーAの空き時間が `10:00-12:00` と `14:00-16:00` の場合、`12:00-14:00` は「空いていない」と厳密に判断してください。スロットとスロットの間は常に予定が埋まっているものとして扱います。\n- 提案する会議時間は、会議の所要時間全体が、**全員の共通する一つの連続した空き時間スロット内に、完全に収まらなければなりません。**\n\n# 処理手順\n\n## 1. メール内容の分析\n受信メール `{{ $json.text }}` から以下の情報を抽出します。\n- **会議の所要時間**: 「1〜2時間」のように幅がある場合は、`[60, 120]` のように可能性のある全ての所要時間（分単位）をリストとして抽出します。明記されていない場合は、**[60]** をデフォルトとします。\n- **先方提示の候補日時**: 提示された時間帯は、相手の空き時間と解釈します。\n\n## 2. 社内メンバーの「空き時間スロット」の取得\n会議の対象者全員について、以下のツールを**必ず**実行し、各メンバーの正確な`available_slots`を取得します。\n\n- 内田陸: 「Uchida san's free schedule」ツール\n- 梶原俊一: 「Kajiwara san's free schedule」ツール\n- 落合建介: 「Ochiai san's free schedule」ツール\n\n## 3. 会議時間の決定ロジック\n\n### Step 3-1: 全員の「共通空き時間スロット」の算出\n- Step 2で取得した全メンバーの`available_slots`を全て比較し、**全員が共通して空いている時間帯（共通スロット）**のリストを正確に作成します。\n\n### Step 3-2: 開催可能時間帯（Intersection）の特定\n- 先方提示の候補日時と、Step 3-1で算出した「共通スロット」が**重なっている時間帯（Intersection）**を正確に計算します。このIntersectionが、実際に会議を開催できる可能性のある時間帯です。\n- **例：** 先方提示が `09:30-11:00`、共通スロットが `10:00-24:00` の場合、**Intersectionは `10:00-11:00`** となります。先方提示が `13:00-15:00`、共通スロットが `10:00-14:00` の場合、**Intersectionは `13:00-14:00`** となります。\n- Intersectionが存在しない場合、この時間帯での開催は不可能です。\n\n### Step 3-3: 最終アクションの決定\n- **Step 3-2で特定したIntersection** を基に、以下の判定を上から順に実行します。\n\n#### ▼判定A: 先方提示の日時で調整可能か？\n1.  **Step 3-2で計算したIntersectionは存在しますか？** → YES\n2.  そのIntersectionの中に、**要求された最短所要時間**（例: 60分）が収まりますか？ → YES\n3.  → **【部分的に、または完全に調整可能】** と判断し、次のサブ判定に進みます。\n    - **サブ判定A-1:【完全確定】**: Intersectionの中に、**要求された最長の所要時間**（例: 120分）も収まる場合。\n        - **アクション**: `status: \"CONFIRMED\"`\n    - **サブ判定A-2:【部分確定と代替提案】**: Intersectionの中に、**最短所要時間は収まるが、最長の所要時間は収まらない**場合。\n        - **アクション**: `status: \"PARTIAL_CONFIRMATION_WITH_PROPOSAL\"`\n\n#### ▼判定B: 先方提示の日時では調整不可能か？\n1.  **Step 3-2で計算したIntersectionが存在しない、または、存在しても最短所要時間が収まらない場合。**\n2.  → **【完全に調整不可能】** と判断し、`status: \"ALTERNATIVE_PROPOSAL\"`として、Step 3-1の**「共通スロット」**から全く新しい候補を3つ探します。\n\n#### ▼判定C: 新規提案か？\n1.  そもそも先方からの候補日時の提示がなかった場合。\n2.  → `status: \"NEW_PROPOSAL\"`として、Step 3-1の**「共通スロット」**から候補を3つ探します。\n\n---\n# 思考と出力の具体例（ワンショット学習）\n\n**## もし、以下の状況が発生した場合：**\n\n- **入力メール**: 「7月22日（火）9:30-11:00」で「1〜2時間」の会議依頼。\n- **Step 3-1の共通スロット**: `{\"date\": \"2025-07-22\", \"slots\": [{\"start_time\": \"00:00\", \"end_time\": \"09:40\"}, {\"start_time\": \"10:00\", \"end_time\": \"24:00\"}]}`\n\n**## あなたは、以下のように思考し、JSONを出力しなければならない：**\n\n1.  **思考 (Step 3-2)**: 先方提示の`09:30-11:00`と共通スロット`10:00-24:00`のIntersectionは`10:00-11:00`である。このIntersectionの長さは60分だ。\n2.  **思考 (Step 3-3)**:\n    - 要求された最短所要時間の「60分」は、Intersection `10:00-11:00` に収まるか？ → YES。\n    - 要求された最長所要時間の「120分」は、Intersection `10:00-11:00` に収まるか？ → NO。\n    - これは「最短は収まるが、最長は収まらない」ケースなので、**サブ判定A-2**に該当する。よって`status`は`PARTIAL_CONFIRMATION_WITH_PROPOSAL`となる。\n3.  **最終出力JSON**:\n\n```json\n{\n  \"status\": \"PARTIAL_CONFIRMATION_WITH_PROPOSAL\",\n  \"summary\": \"ご連絡ありがとうございます。ご提示いただいた7月22日（火）の件ですが、1時間のお打ち合わせでしたら10:00-11:00で調整可能です。もし2時間をご希望の場合は、同時間帯での確保が難しいため、恐れ入りますが以下の代替日程はいかがでしょうか。\",\n  \"meetingDetails\": {\n    \"participants\": [\"内田陸\", \"梶原俊一\"],\n    \"durationMinutes\": [60, 120],\n    \"confirmedSlotForShortestDuration\": \"2025年07月22日(火) 10:00-11:00\",\n    \"alternativeProposalsForLongestDuration\": [\n      \"2025年07月22日(火) 13:00-15:00\",\n      \"2025年07月23日(水) 10:00-12:00\",\n      \"2025年07月24日(木) 14:00-16:00\"\n    ]\n  },\n  \"reasoning\": {\n    \"evaluation\": \"先方提示の9:30-11:00と、こちらの共通空き時間10:00-24:00のIntersectionは10:00-11:00（60分）です。これにより、要求された60分は満たせますが、120分は満たせません。そのため、60分の確定可能枠を提示しつつ、120分の場合の代替案を別途提示します。\"\n  }\n}\n````\n\n-----\n\n# 出力形式\n\n（上記具体例を参考に、各項目を埋めてください。JSONのキー名は状況に応じて柔軟に変更して構いませんが、`status`は必ず指定のものを利用してください。）","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[180,0],"id":"223c2f70-586d-4219-8745-29cff27c44aa","name":"Scheduling Agent"},{"parameters":{"modelName":"models/gemini-2.5-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[160,220],"id":"29a3ccc2-77af-4e99-924f-adb75836ca73","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"FmzErYjM1M40na1K","name":"Google Gemini(PaLM) Api account 6"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[340,220],"id":"41877091-d23e-4921-9944-c1391573b2e2","name":"Think"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Scheduling Agent","type":"main","index":0}]]},"Scheduling Agent":{"main":[[]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Scheduling Agent","type":"ai_languageModel","index":0}]]},"Think":{"ai_tool":[[{"node":"Scheduling Agent","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"e9ec8a78-5640-4119-970f-fab8c372a151","triggerCount":0,"tags":[{"createdAt":"2025-07-03T07:23:34.599Z","updatedAt":"2025-07-03T09:57:04.256Z","id":"Zey1DTgFzw4vuivz","name":"Secretary Agent"}]}